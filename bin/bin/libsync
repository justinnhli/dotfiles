#!/bin/bash

LOCAL_PATH="$HOME/papers"
REMOTE_HOST="justinnhli.com"
REMOTE_PATH="/home/justinnhli/justinnhli.com/library"

EXCLUDES=".*"

remote_full_path() {
	filename="$(basename "$1")"
	echo "$REMOTE_PATH/$(echo "${filename:0:1}" | tr 'A-Z' 'a-z')/$filename"
}

local_full_path() {
	filename="$(basename "$1")"
	echo "$LOCAL_PATH/$(echo "${filename:0:1}" | tr 'A-Z' 'a-z')/$filename"
}

if [ $# -eq 0 ]; then
	action='diff'
else
	action="$1"
fi
shift 1
case "$action" in
	diff)
		local_list="$(cd "$LOCAL_PATH" && find . -name '*.pdf')"
		remote_list="$(ssh dreamhost "cd $REMOTE_PATH && find . -name '*.pdf'")"
		result="$(diff <(echo "$local_list" | sort) <(echo "$remote_list" | sort))"
		if [ "$result" != "" ]; then
			echo 'diff local remote'
			echo "$result"
		fi;;
	sync)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$REMOTE_HOST:$REMOTE_PATH/" "$LOCAL_PATH"
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$LOCAL_PATH/" "$REMOTE_HOST:$REMOTE_PATH";;
	push)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$LOCAL_PATH/" "$REMOTE_HOST:$REMOTE_PATH";;
	pull)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$REMOTE_HOST:$REMOTE_PATH/" "$LOCAL_PATH";;
	rm)
		for arg in $@; do
			ssh "$REMOTE_HOST" "rm -vf '$(remote_full_path "$arg")'"
			rm -vf "$(local_full_path "$arg")"
		done;;
	url)
		for arg in $@; do
			remote_full_path "$arg" | sed 's#.*justinnhli.com#http://justinnhli.com#'
		done;;
	*)
		echo "usage: $0 [diff|sync|pull|push|rm] [args ...]";;
esac
