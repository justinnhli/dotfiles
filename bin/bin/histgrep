#!/usr/bin/env python3

import re
from argparse import ArgumentParser
from os.path import basename, exists as file_exists, expanduser, getmtime, join as join_path, realpath, relpath
from collections import namedtuple

arg_parser = ArgumentParser()
arg_parser.add_argument('patterns', nargs='*')
arg_parser.add_argument('-d', dest='date', action='store')
arg_parser.add_argument('-m', dest='machine', action='store')
arg_parser.add_argument('-p', dest='pwd', action='store')
args = arg_parser.parse_args()

Event = namedtuple('Event', ('date', 'machine', 'pwd', 'command'))

with open(realpath(expanduser('~/Dropbox/personal/logs/shell_history'))) as fd:
    for line in fd:
        try:
            date, machine, pwd, command = line.strip().split('\t', maxsplit=3)
        except ValueError:
            continue
        event = Event(date, machine, pwd, command)
        if args.date is not None and not re.search(args.date, event.date):
            continue
        if args.machine is not None and not re.search(args.machine, event.machine):
            continue
        if args.pwd is not None and not re.search(args.pwd, event.machine):
            continue
        if not all(re.search(pat, event.command) for pat in args.patterns):
            continue
        print('\t'.join((event.date, event.machine, event.pwd, event.command)))
