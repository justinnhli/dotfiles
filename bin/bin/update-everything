#!/bin/bash

# this script needs to be a bash script for the Icon\r removal to work
# I honestly don't understand why

if_exists_do() {
	if [ -d "$2" ]; then
		echo "$1"
		(
			cd "$2" >/dev/null 2>&1
			bash -c "$3"
		)
		echo
	fi
}

if which brew >/dev/null 2>&1; then
	brew update && brew upgrade
	brew cask list 2>/dev/null | while read -r package; do
		package="$(echo "$package" | sed 's/ .*//g')"
		current="$(brew cask list --versions "$package" | sed 's/.* //')"
		cask_info="$(brew cask info "$package")"
		newest="$(echo "$cask_info" | head -n 1 | sed 's/.* //')"
		if [ "$current" != "$newest" ]; then
			echo "$package $current $newest"
			brew cask reinstall "$package"
		fi
	done
	brew cleanup
	echo
fi

python3 $HOME/bin/update-everything.py update-cabal
python3 $HOME/bin/update-everything.py update-arch

if which python3 >/dev/null 2>&1 && python3 -m pip > /dev/null 2>&1; then
	python3 -m pip list --outdated --format=freeze | sed 's/=.*//;' | xargs python3 -m pip install --upgrade
fi

if [ -d "$HOME/Desktop" ]; then
	cd "$HOME/Desktop" || exit
	python3 $HOME/bin/update-everything.py remove-orphans
fi

if [ -d "$HOME/Dropbox" ]; then
	cd "$HOME/Dropbox" || exit
	python3 $HOME/bin/update-everything.py remove-orphans
	python3 $HOME/bin/update-everything.py delete-os-metadata
	python3 $HOME/bin/update-everything.py merge-hsitory

	# set directories to correct permissions
	echo "correcting directory permissions..."
	find . -type d -perm 777 | while read -r f; do
		chmod 755 "$f" && echo "	fixed permissions of $f"
	done
fi
echo

if_exists_do "updating papers library" "$HOME/papers" "blib.py pull"

nvim -c ':PlugUpgrade | qa!'
if_exists_do "updating nvim plugins" "$HOME/.config/nvim/plugged" "git-all pull"

if_exists_do "updating ACT-R" "$HOME/act-r" "svn update"
if_exists_do "updating git repos" "$HOME/git" "git-all pull"
if_exists_do "cleaning git repos" "$HOME/git" "orphan-undos"
