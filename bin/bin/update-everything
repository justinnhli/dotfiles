#!/bin/sh

if_exists_do() {
	if [ -d "$2" ]; then
		echo "$1"
		pushd "$2" >/dev/null 2>&1
		bash -c "$3"
		popd >/dev/null 2>&1
		echo
	fi
}

if which brew >/dev/null 2>&1; then
	if [ "$(hostname)" = 'OXY4776M' ]; then
		root="$(find /usr/local -user root 2>&1)"
		if [ "$root" != "" ]; then
			echo 'found brew permissions issue; sudo-ing to chown'
			echo "$root" | sed 's/^/    /'
			if [ "$(echo "$root" | wc -l)" -le 20 ]; then
				sudo chown "$(whoami)" $root
			else
				sudo chown -R "$(whoami)" /usr/local
			fi
		fi
	fi
	brew update && brew upgrade --all && brew cleanup && brew linkapps
	brew cask update && brew cask cleanup
	echo
fi

if which cabal >/dev/null 2>&1; then
	cabal update
	echo
fi

if which pacaur >/dev/null 2>&1; then
	pacaur --domain aur4.archlinux.org -Syu
	echo
fi

which python python2 python3 | while read python; do
	if ($python -m pip list >/dev/null 2>&1); then
		if [ "$(whoami)" = "root" ]; then
			$python -m pip list --outdated | awk '{print $1}' | xargs "$python" -m pip install -U
		else
			echo "must be root to update pip for $python; run as root: "
			echo "$python -m pip list --outdated | awk '{print \$1}' | xargs \"$python\" -m pip install -U"
			outdated="$($python -m pip list --outdated | sed 's/^/	/')"
			if [ "$outdated" != "" ]; then
				echo "$outdated"
			fi
		fi
	fi
	echo
done

if [ -d ~/Dropbox ]; then
	cd ~/Dropbox || exit

	# remove old vim undo files
	echo "removing old vim undo files..."
	orphan-undos | sed 's/^/	/'

	# remove OS files
	echo "removing OS files..."
	find . -name "$(echo -e "Icon\r")" | while read f; do
		echo "	deleted $f"
	done
	find . -name "$(echo -e "Icon\r")" -delete
	find . -name .DS_Store | while read f; do
		rm -f "$f" && echo "	deleted $f"
	done
	find . -name __MACOSX | while read f; do
		rm -f "$f" && echo "	deleted $f"
	done

	# merge command line history
	echo "merging command line history..."
	filename="$(mktemp /tmp/histfix.XXXXXX)"
	sort ~/Dropbox/personal/logs/shell_history* | uniq | sed 's/ \+$//' > "$filename"
	mv -f "$filename" ~/Dropbox/personal/logs/shell_history
	find ~/Dropbox/personal/logs/ -name 'shell_history *' | while read line; do
		rm -f "$line"
	done

	# set directories to correct permissions
	echo "correcting directory permissions..."
	find . -type d -perm 777 | while read f; do
		chmod 755 "$f" && echo "	fixed permissions of $f"
	done

	# find any conflicting files
	echo "finding conflicted files..."
	find . -name '*conflicted*' | grep -v '\.dropbox\.cache' | sed 's/^/found /; s/^/	/;'

fi
echo

nvim -c ':PlugUpgrade | qa!'
if_exists_do "updating nvim plugins" ~/.config/nvim/plugged "git-all pull"

if_exists_do "updating Soar" ~/Soar "git pull"
if_exists_do "updating ACT-R" ~/act-r "svn update"
if_exists_do "updating git repos" ~/git "git-all pull"
