#!/bin/bash

LOCAL_PATH="$HOME/papers"
REMOTE_HOST="justinnhli.com"
REMOTE_PATH="/home/justinnhli/justinnhli.com/papers"

EXCLUDES=".*"

rel_path() {
	filename="$(basename "$1")"
	initial="$(echo "$filename" | sed 's/\(.\).*/\1/' | tr '[:upper:]' '[:lower:]')"
	echo "$initial/$filename"
}

remote_full_path() {
	echo "$REMOTE_PATH/$(rel_path "$1")"
}

local_full_path() {
	echo "$LOCAL_PATH/$(rel_path "$1")"
}

if [ $# -eq 0 ]; then
	action='diff'
else
	action="$1"
fi
shift 1
case "$action" in
	diff)
		local_list="$(cd "$LOCAL_PATH" && find . -name '*.pdf')"
		remote_list="$(ssh dreamhost "cd $REMOTE_PATH && find . -name '*.pdf'")"
		result="$(diff <(echo "$local_list" | sort) <(echo "$remote_list" | sort))"
		if [ "$result" != "" ]; then
			echo 'diff local remote'
			echo "$result"
		fi;;
	sync)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$REMOTE_HOST:$REMOTE_PATH/" "$LOCAL_PATH"
		python3 "$HOME/git/biblint/biblint.py" index > "$LOCAL_PATH/index.html"
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$LOCAL_PATH/" "$REMOTE_HOST:$REMOTE_PATH";;
	push)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$LOCAL_PATH/" "$REMOTE_HOST:$REMOTE_PATH";;
	pull)
		rsync --archive --progress --rsh=ssh --exclude "$EXCLUDES" "$REMOTE_HOST:$REMOTE_PATH/" "$LOCAL_PATH";;
	search)
		entries="$(cat library.bib | tr '\n' '\t' | tr '@' '\n' | grep '.' | sed 's/	$//')"
		for arg in "$@"; do
			entries="$(echo "$entries" | grep -i "$arg")"
		done
		if [ "$entries" != "" ]; then
			echo "$entries" | sed 's/^/@/' | tr '\t' '\n'
		fi;;
	rm)
		for arg in "$@"; do
			ssh "$REMOTE_HOST" "rm -vf '$(remote_full_path "$arg")'"
			rm -vf "$(local_full_path "$arg")"
		done;;
	url)
		for arg in "$@"; do
			if ! echo "$arg" | grep '\.pdf$'; then
				arg="$arg.pdf"
			fi
			remote_full_path "$arg" | sed "s#^/home/justinnhli#https:/#"
		done;;
	*)
		echo "usage: $0 [diff|sync|pull|push|rm] [args ...]";;
esac
